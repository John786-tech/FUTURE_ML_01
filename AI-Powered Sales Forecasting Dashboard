import warnings
warnings.filterwarnings("ignore")

import logging
logging.getLogger("prophet").setLevel(logging.ERROR)
logging.getLogger("cmdstanpy").setLevel(logging.ERROR)

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

from prophet import Prophet
from sklearn.metrics import mean_absolute_error, mean_squared_error
from IPython.display import display

import kagglehub

path = kagglehub.dataset_download("pratyushakar/rossmann-store-sales")

df = pd.read_csv(f"{path}/train.csv", low_memory=False)

print("Dataset Shape:", df.shape)
display(df.head())

df['Date'] = pd.to_datetime(df['Date'])

daily_sales = (
    df.groupby('Date')['Sales']
    .sum()
    .reset_index()
    .rename(columns={'Date': 'ds', 'Sales': 'y'})
)

plt.figure(figsize=(12,5))
plt.plot(daily_sales['ds'], daily_sales['y'])
plt.title("Historical Sales Trend")
plt.xlabel("Date")
plt.ylabel("Sales")
plt.show()

model = Prophet(
    daily_seasonality=True,
    weekly_seasonality=True,
    yearly_seasonality=True
)

model.fit(daily_sales)

future = model.make_future_dataframe(periods=30)
display(future.tail())

forecast = model.predict(future)

display(
    forecast[['ds', 'yhat', 'yhat_lower', 'yhat_upper']].tail()
)

model.plot(forecast)
plt.title("30-Day Sales Forecast (Rossmann)")
plt.show()

model.plot_components(forecast)
plt.show()

actual = daily_sales['y']
predicted = forecast.loc[:len(daily_sales)-1, 'yhat']

mae = mean_absolute_error(actual, predicted)
rmse = np.sqrt(mean_squared_error(actual, predicted))

print("MAE:", round(mae, 2))
print("RMSE:", round(rmse, 2))

print("SALES FORECAST SUMMARY")
print("----------------------")
print("Last Recorded Sales:", int(daily_sales['y'].iloc[-1]))
print("Next Day Forecast:", int(forecast['yhat'].iloc[-30]))
print("30 Days Avg Forecast:", int(forecast['yhat'].tail(30).mean()))
